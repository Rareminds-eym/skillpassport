openapi: 3.0.3
info:
  title: Organization Subscription Management API
  description: |
    API for managing organization-level subscriptions, license pools, member assignments, 
    billing, and invitations. Enables B2B subscription management for schools, colleges, 
    and universities.
    
    ## Authentication
    All endpoints require Bearer token authentication via the `Authorization` header.
    
    ## Rate Limiting
    - Standard endpoints: 100 requests/minute
    - Bulk operations: 10 requests/minute
    - Purchase operations: 5 requests/minute
    
    ## Error Handling
    All errors follow a consistent format with `error` and optional `details` fields.
  version: 1.0.0
  contact:
    name: API Support
    email: support@skillpassport.com
servers:
  - url: https://payments-api.dark-mode-d021.workers.dev
    description: Production server
  - url: http://localhost:8787
    description: Local development

tags:
  - name: Organization Subscriptions
    description: Purchase and manage organization subscriptions
  - name: License Pools
    description: Create and manage license pools for seat allocation
  - name: License Assignments
    description: Assign and manage licenses for organization members
  - name: Billing
    description: Billing dashboard, invoices, and cost projections
  - name: Invitations
    description: Invite members to join organization with auto-assignment

paths:
  /org-subscriptions/calculate-pricing:
    post:
      tags:
        - Organization Subscriptions
      summary: Calculate bulk pricing with volume discounts
      description: |
        Calculate pricing breakdown for organization subscription purchase.
        Applies volume discounts based on seat count:
        - 50+ seats: 10% discount
        - 100+ seats: 20% discount  
        - 500+ seats: 30% discount
      operationId: calculatePricing
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculatePricingRequest'
            example:
              planId: "plan-uuid-123"
              seatCount: 100
      responses:
        '200':
          description: Pricing breakdown calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PricingBreakdown'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /org-subscriptions/purchase:
    post:
      tags:
        - Organization Subscriptions
      summary: Purchase organization subscription
      description: |
        Purchase a subscription for the organization with Razorpay integration.
        Creates organization_subscription record and initializes license pool.
        Rate limited to 5 requests per minute.
      operationId: purchaseSubscription
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseSubscriptionRequest'
      responses:
        '201':
          description: Subscription purchased successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationSubscription'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  /org-subscriptions:
    get:
      tags:
        - Organization Subscriptions
      summary: Get organization subscriptions
      description: Retrieve all subscriptions for an organization
      operationId: getOrganizationSubscriptions
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: organizationType
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationType'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/SubscriptionStatus'
      responses:
        '200':
          description: List of organization subscriptions
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscriptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrganizationSubscription'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /org-subscriptions/{id}/seats:
    put:
      tags:
        - Organization Subscriptions
      summary: Update subscription seat count
      description: |
        Add or reduce seats for an existing subscription.
        Calculates prorated charges for additions.
      operationId: updateSeatCount
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newSeatCount
              properties:
                newSeatCount:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: Seat count updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationSubscription'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /license-pools:
    post:
      tags:
        - License Pools
      summary: Create license pool
      description: |
        Create a new license pool for organizing seat allocation.
        Pools can be created for specific departments, grades, or member types.
      operationId: createLicensePool
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLicensePoolRequest'
      responses:
        '201':
          description: License pool created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LicensePool'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      tags:
        - License Pools
      summary: Get license pools
      description: Retrieve all license pools for an organization
      operationId: getLicensePools
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: organizationType
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationType'
      responses:
        '200':
          description: List of license pools
          content:
            application/json:
              schema:
                type: object
                properties:
                  pools:
                    type: array
                    items:
                      $ref: '#/components/schemas/LicensePool'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /license-pools/{id}/allocation:
    put:
      tags:
        - License Pools
      summary: Update pool seat allocation
      description: Update the number of seats allocated to a license pool
      operationId: updatePoolAllocation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newAllocation
              properties:
                newAllocation:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: Allocation updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LicensePool'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /license-pools/{id}/auto-assignment:
    post:
      tags:
        - License Pools
      summary: Configure auto-assignment rules
      description: |
        Configure automatic license assignment rules for a pool.
        New members matching criteria will automatically receive licenses.
      operationId: configureAutoAssignment
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                autoAssignNewMembers:
                  type: boolean
                assignmentCriteria:
                  type: object
                  additionalProperties: true
                  example:
                    department: "Computer Science"
                    grade: "10"
      responses:
        '200':
          description: Auto-assignment configured successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LicensePool'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /license-assignments:
    post:
      tags:
        - License Assignments
      summary: Assign license to user
      description: Assign a license from a pool to a specific user
      operationId: assignLicense
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignLicenseRequest'
      responses:
        '201':
          description: License assigned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LicenseAssignment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: No available seats or user already assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /license-assignments/bulk:
    post:
      tags:
        - License Assignments
      summary: Bulk assign licenses
      description: |
        Assign licenses to multiple users in a single operation.
        Rate limited to 10 requests per minute, max 100 users per batch.
      operationId: bulkAssignLicenses
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkAssignRequest'
      responses:
        '200':
          description: Bulk assignment completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkAssignResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  /license-assignments/{id}:
    delete:
      tags:
        - License Assignments
      summary: Unassign/revoke license
      description: Revoke a license assignment and return seat to pool
      operationId: unassignLicense
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Reason for revocation
      responses:
        '200':
          description: License unassigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /license-assignments/user/{userId}:
    get:
      tags:
        - License Assignments
      summary: Get user's license assignments
      description: Retrieve all license assignments for a specific user
      operationId: getUserAssignments
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of user's assignments
          content:
            application/json:
              schema:
                type: object
                properties:
                  assignments:
                    type: array
                    items:
                      $ref: '#/components/schemas/LicenseAssignment'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /license-assignments/transfer:
    post:
      tags:
        - License Assignments
      summary: Transfer license between users
      description: Transfer a license from one user to another
      operationId: transferLicense
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferLicenseRequest'
      responses:
        '200':
          description: License transferred successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LicenseAssignment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /org-billing/dashboard:
    get:
      tags:
        - Billing
      summary: Get billing dashboard
      description: |
        Retrieve comprehensive billing dashboard with cost breakdown,
        seat utilization, upcoming renewals, and payment history.
      operationId: getBillingDashboard
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: organizationType
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationType'
      responses:
        '200':
          description: Billing dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingDashboard'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /org-billing/invoices:
    get:
      tags:
        - Billing
      summary: Get invoice history
      description: Retrieve invoice history for an organization
      operationId: getInvoiceHistory
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: organizationType
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationType'
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of invoices
          content:
            application/json:
              schema:
                type: object
                properties:
                  invoices:
                    type: array
                    items:
                      $ref: '#/components/schemas/Invoice'
                  total:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /org-billing/invoice/{id}/download:
    get:
      tags:
        - Billing
      summary: Download invoice PDF
      description: Download invoice as PDF document
      operationId: downloadInvoice
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Invoice PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /org-billing/cost-projection:
    get:
      tags:
        - Billing
      summary: Project monthly cost
      description: Calculate projected monthly cost for an organization
      operationId: projectMonthlyCost
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: organizationType
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationType'
      responses:
        '200':
          description: Cost projection
          content:
            application/json:
              schema:
                type: object
                properties:
                  projectedMonthlyCost:
                    type: number
                    format: decimal
                  breakdown:
                    type: object
                    properties:
                      subscriptions:
                        type: number
                      addons:
                        type: number
        '401':
          $ref: '#/components/responses/Unauthorized'

  /org-billing/calculate-seat-addition:
    post:
      tags:
        - Billing
      summary: Calculate seat addition cost
      description: Calculate prorated cost for adding seats to a subscription
      operationId: calculateSeatAdditionCost
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subscriptionId
                - additionalSeats
              properties:
                subscriptionId:
                  type: string
                  format: uuid
                additionalSeats:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: Cost calculation
          content:
            application/json:
              schema:
                type: object
                properties:
                  additionalSeats:
                    type: integer
                  proratedCost:
                    type: number
                  daysRemaining:
                    type: integer
                  newTotalSeats:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /org-invitations:
    post:
      tags:
        - Invitations
      summary: Send member invitation
      description: |
        Send invitation to join organization with optional auto-assignment.
        Generates secure invitation token valid for 7 days.
      operationId: inviteMember
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteMemberRequest'
      responses:
        '201':
          description: Invitation sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationInvitation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Pending invitation already exists for this email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Invitations
      summary: Get pending invitations
      description: Retrieve all pending invitations for an organization
      operationId: getPendingInvitations
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: organizationType
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationType'
      responses:
        '200':
          description: List of pending invitations
          content:
            application/json:
              schema:
                type: object
                properties:
                  invitations:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrganizationInvitation'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /org-invitations/{id}/accept:
    post:
      tags:
        - Invitations
      summary: Accept invitation
      description: Accept an organization invitation using the token
      operationId: acceptInvitation
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - userId
              properties:
                token:
                  type: string
                userId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Invitation accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  organization:
                    type: object
                  assignedLicense:
                    $ref: '#/components/schemas/LicenseAssignment'
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /org-invitations/{id}/cancel:
    delete:
      tags:
        - Invitations
      summary: Cancel invitation
      description: Cancel a pending invitation
      operationId: cancelInvitation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invitation cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'


components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token

  schemas:
    OrganizationType:
      type: string
      enum: [school, college, university]

    SubscriptionStatus:
      type: string
      enum: [active, paused, cancelled, expired, grace_period]

    MemberType:
      type: string
      enum: [educator, student, both]

    AssignmentStatus:
      type: string
      enum: [active, suspended, revoked, expired]

    InvitationStatus:
      type: string
      enum: [pending, accepted, expired, cancelled]

    CalculatePricingRequest:
      type: object
      required:
        - planId
        - seatCount
      properties:
        planId:
          type: string
          format: uuid
        seatCount:
          type: integer
          minimum: 1

    PricingBreakdown:
      type: object
      properties:
        basePrice:
          type: number
          format: decimal
        seatCount:
          type: integer
        subtotal:
          type: number
          format: decimal
        discountPercentage:
          type: integer
          description: "Volume discount: 10% (50+), 20% (100+), 30% (500+)"
        discountAmount:
          type: number
          format: decimal
        taxAmount:
          type: number
          format: decimal
          description: "18% GST"
        finalAmount:
          type: number
          format: decimal
        pricePerSeat:
          type: number
          format: decimal

    PurchaseSubscriptionRequest:
      type: object
      required:
        - organizationId
        - organizationType
        - planId
        - seatCount
        - targetMemberType
        - billingCycle
      properties:
        organizationId:
          type: string
          format: uuid
        organizationType:
          $ref: '#/components/schemas/OrganizationType'
        planId:
          type: string
          format: uuid
        seatCount:
          type: integer
          minimum: 1
        targetMemberType:
          $ref: '#/components/schemas/MemberType'
        billingCycle:
          type: string
          enum: [monthly, annual]
        autoRenew:
          type: boolean
          default: true
        paymentMethod:
          type: string

    OrganizationSubscription:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        organizationType:
          $ref: '#/components/schemas/OrganizationType'
        subscriptionPlanId:
          type: string
          format: uuid
        purchasedBy:
          type: string
          format: uuid
        totalSeats:
          type: integer
        assignedSeats:
          type: integer
        availableSeats:
          type: integer
        targetMemberType:
          $ref: '#/components/schemas/MemberType'
        status:
          $ref: '#/components/schemas/SubscriptionStatus'
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
        autoRenew:
          type: boolean
        pricePerSeat:
          type: number
          format: decimal
        totalAmount:
          type: number
          format: decimal
        discountPercentage:
          type: integer
        finalAmount:
          type: number
          format: decimal
        razorpaySubscriptionId:
          type: string
        razorpayOrderId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateLicensePoolRequest:
      type: object
      required:
        - organizationSubscriptionId
        - organizationId
        - organizationType
        - memberType
        - allocatedSeats
      properties:
        organizationSubscriptionId:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        organizationType:
          $ref: '#/components/schemas/OrganizationType'
        poolName:
          type: string
          maxLength: 100
          example: "Computer Science Department"
        memberType:
          type: string
          enum: [educator, student]
        allocatedSeats:
          type: integer
          minimum: 1
        autoAssignNewMembers:
          type: boolean
          default: false
        assignmentCriteria:
          type: object
          additionalProperties: true

    LicensePool:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organizationSubscriptionId:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        organizationType:
          $ref: '#/components/schemas/OrganizationType'
        poolName:
          type: string
        memberType:
          type: string
          enum: [educator, student]
        allocatedSeats:
          type: integer
        assignedSeats:
          type: integer
        availableSeats:
          type: integer
        autoAssignNewMembers:
          type: boolean
        assignmentCriteria:
          type: object
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        createdBy:
          type: string
          format: uuid

    AssignLicenseRequest:
      type: object
      required:
        - poolId
        - userId
        - assignedBy
      properties:
        poolId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        assignedBy:
          type: string
          format: uuid
        memberType:
          type: string
          enum: [educator, student]

    LicenseAssignment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        licensePoolId:
          type: string
          format: uuid
        organizationSubscriptionId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        memberType:
          type: string
          enum: [educator, student]
        status:
          $ref: '#/components/schemas/AssignmentStatus'
        assignedAt:
          type: string
          format: date-time
        assignedBy:
          type: string
          format: uuid
        expiresAt:
          type: string
          format: date-time
        revokedAt:
          type: string
          format: date-time
        revokedBy:
          type: string
          format: uuid
        revocationReason:
          type: string
        transferredFrom:
          type: string
          format: uuid
        transferredTo:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    BulkAssignRequest:
      type: object
      required:
        - poolId
        - userIds
        - assignedBy
      properties:
        poolId:
          type: string
          format: uuid
        userIds:
          type: array
          items:
            type: string
            format: uuid
          maxItems: 100
        assignedBy:
          type: string
          format: uuid

    BulkAssignResponse:
      type: object
      properties:
        successful:
          type: array
          items:
            $ref: '#/components/schemas/LicenseAssignment'
        failed:
          type: array
          items:
            type: object
            properties:
              userId:
                type: string
                format: uuid
              error:
                type: string
        totalRequested:
          type: integer
        totalSuccessful:
          type: integer
        totalFailed:
          type: integer

    TransferLicenseRequest:
      type: object
      required:
        - fromUserId
        - toUserId
        - transferredBy
        - organizationSubscriptionId
      properties:
        fromUserId:
          type: string
          format: uuid
        toUserId:
          type: string
          format: uuid
        transferredBy:
          type: string
          format: uuid
        organizationSubscriptionId:
          type: string
          format: uuid

    BillingDashboard:
      type: object
      properties:
        organizationId:
          type: string
          format: uuid
        currentPeriod:
          type: object
          properties:
            startDate:
              type: string
              format: date-time
            endDate:
              type: string
              format: date-time
            totalCost:
              type: number
              format: decimal
            subscriptionCosts:
              type: number
              format: decimal
            addonCosts:
              type: number
              format: decimal
        subscriptions:
          type: array
          items:
            type: object
            properties:
              planName:
                type: string
              seatCount:
                type: integer
              utilization:
                type: number
                description: Percentage of seats assigned
              monthlyCost:
                type: number
                format: decimal
        addons:
          type: array
          items:
            type: object
            properties:
              addonName:
                type: string
              memberCount:
                type: integer
              monthlyCost:
                type: number
                format: decimal
        upcomingRenewals:
          type: array
          items:
            type: object
            properties:
              subscriptionId:
                type: string
                format: uuid
              renewalDate:
                type: string
                format: date-time
              estimatedCost:
                type: number
                format: decimal
        paymentHistory:
          type: array
          items:
            $ref: '#/components/schemas/PaymentRecord'

    PaymentRecord:
      type: object
      properties:
        id:
          type: string
          format: uuid
        amount:
          type: number
          format: decimal
        status:
          type: string
          enum: [pending, completed, failed, refunded]
        paymentDate:
          type: string
          format: date-time
        description:
          type: string
        invoiceId:
          type: string

    Invoice:
      type: object
      properties:
        id:
          type: string
        invoiceNumber:
          type: string
        organizationId:
          type: string
          format: uuid
        amount:
          type: number
          format: decimal
        taxAmount:
          type: number
          format: decimal
        totalAmount:
          type: number
          format: decimal
        status:
          type: string
          enum: [draft, sent, paid, overdue, cancelled]
        issueDate:
          type: string
          format: date-time
        dueDate:
          type: string
          format: date-time
        paidDate:
          type: string
          format: date-time
        lineItems:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              quantity:
                type: integer
              unitPrice:
                type: number
                format: decimal
              amount:
                type: number
                format: decimal

    InviteMemberRequest:
      type: object
      required:
        - organizationId
        - organizationType
        - email
        - memberType
        - invitedBy
      properties:
        organizationId:
          type: string
          format: uuid
        organizationType:
          $ref: '#/components/schemas/OrganizationType'
        email:
          type: string
          format: email
        memberType:
          type: string
          enum: [educator, student]
        invitedBy:
          type: string
          format: uuid
        autoAssignSubscription:
          type: boolean
          default: false
        licensePoolId:
          type: string
          format: uuid
        invitationMessage:
          type: string
          maxLength: 500

    OrganizationInvitation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        organizationType:
          $ref: '#/components/schemas/OrganizationType'
        email:
          type: string
          format: email
        memberType:
          type: string
          enum: [educator, student]
        invitedBy:
          type: string
          format: uuid
        autoAssignSubscription:
          type: boolean
        targetLicensePoolId:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/InvitationStatus'
        invitationToken:
          type: string
        expiresAt:
          type: string
          format: date-time
        acceptedAt:
          type: string
          format: date-time
        acceptedBy:
          type: string
          format: uuid
        invitationMessage:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
        details:
          type: object
          additionalProperties: true
        code:
          type: string

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid request"
            details:
              seatCount: "Must be a positive integer"

    Unauthorized:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Resource not found"

    RateLimited:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Rate limit exceeded"
            details:
              retryAfter: 60

security:
  - bearerAuth: []
