# JSON Parsing Fix for Question Generation

**Date**: January 31, 2026  
**Issue**: AI-generated questions failing to parse, falling back to offline questions  
**Status**: âœ… FIXED  

---

## Problem

When generating adaptive aptitude questions, the logs showed:

```
âš ï¸ Initial JSON parse failed, attempting repair...
âš ï¸ Repair attempt 1 failed, trying more aggressive repair...
âœ˜ [ERROR] âš ï¸ AI generation failed, falling back: Failed to parse JSON after all repair attempts
ğŸ”„ Using fallback logic
```

**Root Cause**: The JSON parsing function had several issues:
1. Removed newlines too early, breaking multi-line strings
2. Didn't handle both array and object responses properly
3. Returned wrapped object `{questions: [...]}` instead of array when extracting
4. Lacked detailed logging to diagnose issues
5. Prompt wasn't explicit enough about expected JSON format

---

## Solution

### 1. Enhanced JSON Parsing (`functions/api/shared/ai-config.ts`)

**Improvements**:
- âœ… Added success logging at each parsing stage
- âœ… Preserve newlines during initial repairs (only remove at end)
- âœ… Better control character handling (preserve some formatting)
- âœ… Return array directly when extracting questions (not wrapped)
- âœ… Added array extraction fallback for malformed arrays
- âœ… More detailed error logging with content preview

**Key Changes**:
```typescript
// Before: Removed newlines too early
cleaned = cleaned.replace(/\n/g, ' ')

// After: Remove newlines only in final aggressive repair
repaired = repaired.replace(/\n/g, ' ')

// Before: Returned wrapped object
return { questions };

// After: Return array directly
return questions;
```

### 2. Better Response Handling (`functions/api/question-generation/handlers/adaptive.ts`)

**Improvements**:
- âœ… Handle both array and object responses
- âœ… Extract questions array from object if present
- âœ… Wrap single object in array if needed
- âœ… Clear error messages

**Key Changes**:
```typescript
const parsed = repairAndParseJSON(content);

// Handle both formats
if (Array.isArray(parsed)) {
    return parsed;
} else if (parsed && Array.isArray(parsed.questions)) {
    return parsed.questions;
} else if (parsed && typeof parsed === 'object') {
    return [parsed];
}
```

### 3. Improved Prompt Clarity

**Improvements**:
- âœ… Explicit JSON format specification
- âœ… Example output provided
- âœ… Clear instruction: "no markdown, no code blocks"
- âœ… Detailed schema for each question object

**Key Changes**:
```typescript
Output format: Return ONLY a valid JSON array of question objects. Each question must have:
{
  "text": "question text",
  "options": {"A": "...", "B": "...", "C": "...", "D": "..."},
  "correctAnswer": "A" | "B" | "C" | "D",
  "explanation": "why this is correct"
}

Example: [{"text":"What is 2+2?","options":{"A":"3","B":"4","C":"5","D":"6"},"correctAnswer":"B","explanation":"2+2=4"}]

Return ONLY the JSON array, no markdown, no explanation, no code blocks.
```

---

## Testing

After this fix, you should see:

### Success Case:
```
ğŸ¤– Generating 1 questions for higher_secondary (adaptive_core) - Difficulty 3
ğŸ”„ Trying google/gemini-2.0-flash-001 (attempt 1/3)
âœ… google/gemini-2.0-flash-001 succeeded
âœ… JSON parsed successfully on first attempt
âœ… AI generated 1 unique questions (filtered from 1)
```

### Fallback Case (if AI still has issues):
```
ğŸ¤– Generating 1 questions for higher_secondary (adaptive_core) - Difficulty 3
ğŸ”„ Trying google/gemini-2.0-flash-001 (attempt 1/3)
âœ… google/gemini-2.0-flash-001 succeeded
âš ï¸ Initial JSON parse failed, attempting repair...
ğŸ“„ First 200 chars: [{"text":"...
âœ… JSON parsed successfully after basic repair
âœ… AI generated 1 unique questions (filtered from 1)
```

---

## Impact

**Positive**:
- âœ… Better AI question generation success rate
- âœ… More detailed logging for debugging
- âœ… Handles multiple response formats
- âœ… Clearer prompts = better AI responses
- âœ… Graceful degradation still works

**No Negative Impact**:
- âŒ No breaking changes
- âŒ Fallback logic still works if parsing fails
- âŒ No performance impact

---

## Files Modified

1. **functions/api/shared/ai-config.ts**
   - Enhanced `repairAndParseJSON()` function
   - Better error handling and logging
   - Improved repair strategies

2. **functions/api/question-generation/handlers/adaptive.ts**
   - Updated `callOpenRouterAndParse()` to handle multiple formats
   - Improved prompt with explicit format instructions
   - Added example output

---

## Verification Steps

1. **Start the server**:
   ```bash
   npm run pages:dev
   ```

2. **Start a new adaptive test** in the browser

3. **Watch the logs** for:
   - âœ… "JSON parsed successfully" messages
   - âœ… "AI generated X unique questions" messages
   - âŒ No more "Failed to parse JSON after all repair attempts"

4. **Expected behavior**:
   - Questions should be generated by AI (not fallback)
   - No parsing errors in logs
   - Test progresses smoothly

---

## Related Issues

- **RLS Fix**: Already completed (using `createSupabaseAdminClient`)
- **Duplicate Prevention**: Working correctly with exclusion lists
- **Adaptive Algorithm**: Functioning properly

---

## Next Steps

If you still see parsing errors after this fix:

1. **Check the raw AI response**:
   - Look for the "ğŸ“„ First 200 chars:" log
   - Verify the AI is returning valid JSON

2. **Try different AI model**:
   - The fallback chain will automatically try other models
   - Check which model succeeded in logs

3. **Adjust temperature**:
   - Lower temperature (0.3-0.5) = more consistent formatting
   - Current: 0.7 (balanced)

---

## Conclusion

âœ… **JSON Parsing Fixed**

The question generation system now has:
- Robust JSON parsing with multiple repair strategies
- Better error handling and logging
- Clearer prompts for AI models
- Support for multiple response formats
- Graceful fallback if all else fails

**Status**: Ready for testing

---

**Fixed By**: Kiro AI Agent  
**Date**: January 31, 2026  
**Testing**: Pending user verification
