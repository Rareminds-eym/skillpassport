<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Password Issue Debugger</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f7fa;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2563eb;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #64748b;
      margin-bottom: 30px;
    }
    .section {
      margin: 25px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
    }
    .section h3 {
      margin-top: 0;
      color: #1e293b;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .label {
      font-weight: 600;
      color: #475569;
    }
    .value {
      color: #1e293b;
      font-family: 'Courier New', monospace;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status.success {
      background: #dcfce7;
      color: #166534;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .status.warning {
      background: #fef3c7;
      color: #92400e;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
    }
    button:hover {
      background: #1d4ed8;
    }
    .test-form {
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .alert.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .alert.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Student Password Issue Debugger</h1>
    <p class="subtitle">This tool helps diagnose why password changes are failing</p>

    <div id="results"></div>

    <div class="test-form">
      <h3>Test Password Verification</h3>
      <p style="color: #64748b; font-size: 14px;">Enter your current credentials to test the password verification flow:</p>
      
      <label style="font-weight: 600; color: #475569;">Email:</label>
      <input type="email" id="testEmail" placeholder="student@example.com">
      
      <label style="font-weight: 600; color: #475569;">Current Password:</label>
      <input type="password" id="testPassword" placeholder="Enter your current password">
      
      <button onclick="testPasswordVerification()">Test Password Verification</button>
      
      <div id="testResults"></div>
    </div>

    <button onclick="runDiagnostics()">Run Full Diagnostics</button>
  </div>

  <script>
    // Initialize Supabase - REPLACE WITH YOUR ACTUAL VALUES
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    
    let supabase;
    
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (err) {
      document.getElementById('results').innerHTML = `
        <div class="alert error">
          <strong>‚ö†Ô∏è Configuration Error:</strong><br>
          Please update SUPABASE_URL and SUPABASE_ANON_KEY in this HTML file with your actual Supabase credentials.
          <br><br>
          You can find these in your .env file:
          <pre>VITE_SUPABASE_URL=...
VITE_SUPABASE_ANON_KEY=...</pre>
        </div>
      `;
    }

    async function runDiagnostics() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<p>Running diagnostics...</p>';

      let html = '';

      // Check 1: LocalStorage
      html += '<div class="section">';
      html += '<h3>üì¶ Step 1: LocalStorage Data</h3>';
      
      const storedUser = localStorage.getItem('user');
      const storedEmail = localStorage.getItem('userEmail');
      
      if (storedUser) {
        try {
          const user = JSON.parse(storedUser);
          html += '<div class="info-row"><span class="label">Stored User:</span><span class="value">' + JSON.stringify(user, null, 2) + '</span></div>';
          html += '<div class="info-row"><span class="label">Email from user object:</span><span class="value">' + (user.email || 'NOT FOUND') + '</span></div>';
        } catch (e) {
          html += '<div class="info-row"><span class="label">Error:</span><span class="value">Invalid JSON in localStorage</span></div>';
        }
      } else {
        html += '<div class="alert warning">No user data in localStorage</div>';
      }
      
      if (storedEmail) {
        html += '<div class="info-row"><span class="label">Stored Email:</span><span class="value">' + storedEmail + '</span></div>';
      }
      html += '</div>';

      // Check 2: Supabase Auth Session
      html += '<div class="section">';
      html += '<h3>üîê Step 2: Supabase Auth Session</h3>';
      
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          html += '<div class="alert error">Error: ' + error.message + '</div>';
        } else if (session?.user) {
          html += '<div class="info-row"><span class="label">Status:</span><span class="status success">Logged In</span></div>';
          html += '<div class="info-row"><span class="label">User ID:</span><span class="value">' + session.user.id + '</span></div>';
          html += '<div class="info-row"><span class="label">Email:</span><span class="value">' + session.user.email + '</span></div>';
          html += '<div class="info-row"><span class="label">Email Confirmed:</span><span class="value">' + (session.user.email_confirmed_at ? 'Yes' : 'No') + '</span></div>';
          html += '<div class="info-row"><span class="label">Last Sign In:</span><span class="value">' + (session.user.last_sign_in_at || 'Never') + '</span></div>';
          
          // Store for comparison
          window.authEmail = session.user.email;
        } else {
          html += '<div class="alert warning">No active Supabase session found. User may not be logged in.</div>';
        }
      } catch (err) {
        html += '<div class="alert error">Error checking session: ' + err.message + '</div>';
      }
      html += '</div>';

      // Check 3: Students Table
      html += '<div class="section">';
      html += '<h3>üë§ Step 3: Students Table Record</h3>';
      
      if (window.authEmail) {
        try {
          const { data: students, error } = await supabase
            .from('students')
            .select('id, email, name, contactNumber, created_at')
            .eq('email', window.authEmail);

          if (error) {
            html += '<div class="alert error">Error: ' + error.message + '</div>';
          } else if (students && students.length > 0) {
            html += '<div class="info-row"><span class="label">Status:</span><span class="status success">Found</span></div>';
            students.forEach((student, idx) => {
              html += '<div class="info-row"><span class="label">Student ID:</span><span class="value">' + student.id + '</span></div>';
              html += '<div class="info-row"><span class="label">Email:</span><span class="value">' + student.email + '</span></div>';
              html += '<div class="info-row"><span class="label">Name:</span><span class="value">' + (student.name || 'Not set') + '</span></div>';
              html += '<div class="info-row"><span class="label">Phone:</span><span class="value">' + (student.contactNumber || 'Not set') + '</span></div>';
            });
            
            if (students.length > 1) {
              html += '<div class="alert warning">‚ö†Ô∏è Multiple student records found for this email!</div>';
            }
          } else {
            html += '<div class="alert error">No student record found for email: ' + window.authEmail + '</div>';
          }
        } catch (err) {
          html += '<div class="alert error">Error: ' + err.message + '</div>';
        }
      } else {
        html += '<div class="alert warning">Cannot check - no auth email available</div>';
      }
      html += '</div>';

      // Check 4: Diagnosis
      html += '<div class="section">';
      html += '<h3>ü©∫ Diagnosis</h3>';
      
      const localUser = storedUser ? JSON.parse(storedUser) : null;
      const localEmail = localUser?.email || storedEmail;
      
      if (localEmail && window.authEmail && localEmail !== window.authEmail) {
        html += '<div class="alert error">';
        html += '<strong>‚ùå EMAIL MISMATCH DETECTED!</strong><br><br>';
        html += 'LocalStorage email: <code>' + localEmail + '</code><br>';
        html += 'Supabase Auth email: <code>' + window.authEmail + '</code><br><br>';
        html += 'This is why password changes are failing. The Settings page is using the localStorage email, but Supabase Auth has a different email.';
        html += '</div>';
        
        html += '<div class="alert info">';
        html += '<strong>üí° Solution:</strong><br>';
        html += '1. Log out completely<br>';
        html += '2. Clear browser localStorage<br>';
        html += '3. Log in again with the correct credentials<br>';
        html += '4. Or update the localStorage to match the auth email';
        html += '</div>';
      } else if (!window.authEmail) {
        html += '<div class="alert error">';
        html += '<strong>‚ùå NO ACTIVE SESSION!</strong><br><br>';
        html += 'There is no active Supabase authentication session. You need to log in first.';
        html += '</div>';
      } else {
        html += '<div class="alert success">';
        html += '<strong>‚úÖ Emails Match!</strong><br><br>';
        html += 'Email: <code>' + window.authEmail + '</code><br><br>';
        html += 'The issue might be:<br>';
        html += '‚Ä¢ Incorrect current password<br>';
        html += '‚Ä¢ Password was changed elsewhere<br>';
        html += '‚Ä¢ Session expired - try logging in again';
        html += '</div>';
      }
      html += '</div>';

      resultsDiv.innerHTML = html;
    }

    async function testPasswordVerification() {
      const email = document.getElementById('testEmail').value;
      const password = document.getElementById('testPassword').value;
      const resultsDiv = document.getElementById('testResults');

      if (!email || !password) {
        resultsDiv.innerHTML = '<div class="alert error">Please enter both email and password</div>';
        return;
      }

      resultsDiv.innerHTML = '<p>Testing password verification...</p>';

      try {
        // Test 1: Try to sign in with the credentials
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          resultsDiv.innerHTML = `
            <div class="alert error">
              <strong>‚ùå Password Verification Failed</strong><br><br>
              Error: ${error.message}<br><br>
              This means the current password you entered is incorrect, or the email doesn't exist in Supabase Auth.
            </div>
          `;
        } else if (data?.user) {
          resultsDiv.innerHTML = `
            <div class="alert success">
              <strong>‚úÖ Password Verification Successful!</strong><br><br>
              User ID: ${data.user.id}<br>
              Email: ${data.user.email}<br><br>
              The password is correct. If password change is still failing, the issue is likely:<br>
              ‚Ä¢ The email in Settings page doesn't match this email<br>
              ‚Ä¢ The new password doesn't meet requirements (min 6 characters)<br>
              ‚Ä¢ Session expired - try refreshing the page
            </div>
          `;
        }
      } catch (err) {
        resultsDiv.innerHTML = `
          <div class="alert error">
            <strong>‚ùå Error:</strong><br>
            ${err.message}
          </div>
        `;
      }
    }

    // Auto-run diagnostics on load
    if (supabase) {
      runDiagnostics();
    }
  </script>
</body>
</html>
