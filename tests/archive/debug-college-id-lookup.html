<!DOCTYPE html>
<html>
<head>
  <title>Debug College ID Lookup</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
    pre { background: #000; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>üîç College ID Lookup Debug</h1>
  <div id="output"></div>

  <script type="module">
    const output = document.getElementById('output');
    
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = message;
      output.appendChild(div);
    }

    async function debug() {
      try {
        // Get env vars from localStorage or prompt
        const supabaseUrl = localStorage.getItem('VITE_SUPABASE_URL') || prompt('Enter VITE_SUPABASE_URL:');
        const supabaseKey = localStorage.getItem('VITE_SUPABASE_ANON_KEY') || prompt('Enter VITE_SUPABASE_ANON_KEY:');
        
        if (supabaseUrl && supabaseKey) {
          localStorage.setItem('VITE_SUPABASE_URL', supabaseUrl);
          localStorage.setItem('VITE_SUPABASE_ANON_KEY', supabaseKey);
        }

        const { createClient } = supabase;
        const client = createClient(supabaseUrl, supabaseKey);

        log('<div class="section"><h2>Step 1: Get Current User</h2></div>');
        const { data: { user }, error: authError } = await client.auth.getUser();
        
        if (authError || !user) {
          log(`<span class="error">‚ùå Not logged in: ${authError?.message || 'No user'}</span>`);
          log('<p class="warning">Please log in to the app first, then refresh this page.</p>');
          return;
        }

        log(`<span class="success">‚úÖ Logged in as: ${user.email}</span>`);
        log(`<pre>${JSON.stringify({ id: user.id, email: user.email, metadata: user.user_metadata }, null, 2)}</pre>`);

        // Check college_lecturers
        log('<div class="section"><h2>Step 2: Check college_lecturers</h2></div>');
        const { data: lecturer, error: lecError } = await client
          .from('college_lecturers')
          .select('id, collegeId, email, first_name, last_name, metadata')
          .eq('email', user.email)
          .maybeSingle();

        if (lecError) {
          log(`<span class="error">‚ùå Error: ${lecError.message}</span>`);
        } else if (lecturer) {
          log(`<span class="success">‚úÖ Found in college_lecturers</span>`);
          log(`<pre>${JSON.stringify(lecturer, null, 2)}</pre>`);
          if (lecturer.collegeId) {
            log(`<span class="success">‚úÖ College ID: ${lecturer.collegeId}</span>`);
          }
        } else {
          log(`<span class="warning">‚ö†Ô∏è  Not found in college_lecturers</span>`);
        }

        // Check colleges by email
        log('<div class="section"><h2>Step 3: Check colleges (email)</h2></div>');
        const { data: collegeEmail, error: emailErr } = await client
          .from('colleges')
          .select('id, name, email, admin_email')
          .eq('email', user.email)
          .maybeSingle();

        if (emailErr) {
          log(`<span class="error">‚ùå Error: ${emailErr.message}</span>`);
        } else if (collegeEmail) {
          log(`<span class="success">‚úÖ Found college by email</span>`);
          log(`<pre>${JSON.stringify(collegeEmail, null, 2)}</pre>`);
        } else {
          log(`<span class="warning">‚ö†Ô∏è  Not found by email</span>`);
        }

        // Check colleges by admin_email
        log('<div class="section"><h2>Step 4: Check colleges (admin_email)</h2></div>');
        const { data: collegeAdmin, error: adminErr } = await client
          .from('colleges')
          .select('id, name, email, admin_email')
          .eq('admin_email', user.email)
          .maybeSingle();

        if (adminErr) {
          log(`<span class="error">‚ùå Error: ${adminErr.message}</span>`);
        } else if (collegeAdmin) {
          log(`<span class="success">‚úÖ Found college by admin_email</span>`);
          log(`<pre>${JSON.stringify(collegeAdmin, null, 2)}</pre>`);
        } else {
          log(`<span class="warning">‚ö†Ô∏è  Not found by admin_email</span>`);
        }

        // Get first college as fallback
        log('<div class="section"><h2>Step 5: Get first available college</h2></div>');
        const { data: firstCollege, error: firstErr } = await client
          .from('colleges')
          .select('id, name')
          .limit(1)
          .maybeSingle();

        if (firstErr) {
          log(`<span class="error">‚ùå Error: ${firstErr.message}</span>`);
        } else if (firstCollege) {
          log(`<span class="success">‚úÖ First college available</span>`);
          log(`<pre>${JSON.stringify(firstCollege, null, 2)}</pre>`);
        } else {
          log(`<span class="error">‚ùå No colleges found in database!</span>`);
        }

        // Summary
        log('<div class="section"><h2>üìä SUMMARY</h2></div>');
        const collegeId = lecturer?.collegeId || collegeEmail?.id || collegeAdmin?.id || firstCollege?.id;
        
        if (collegeId) {
          log(`<span class="success">‚úÖ College ID resolved: ${collegeId}</span>`);
          log(`<p>The user creation should work now. Check browser console for detailed logs.</p>`);
        } else {
          log(`<span class="error">‚ùå Could not resolve college ID</span>`);
          log(`<p class="warning">SOLUTION: You need to either:</p>`);
          log(`<ol>
            <li>Add your email (${user.email}) to the college_lecturers table with a collegeId</li>
            <li>Add your email to the colleges table as email or admin_email</li>
            <li>Create at least one college in the colleges table</li>
          </ol>`);
        }

      } catch (error) {
        log(`<span class="error">‚ùå Fatal error: ${error.message}</span>`);
        console.error(error);
      }
    }

    debug();
  </script>
</body>
</html>
