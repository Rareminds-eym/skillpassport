<!DOCTYPE html>
<html>
<head>
    <title>Test School Lookup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test School Admin Lookup</h1>
    <div id="output"></div>
    
    <script type="module">
        // Load from .env - you'll need to replace these with actual values
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const output = document.getElementById('output');
        
        async function testLookup() {
            output.innerHTML = '<p>Testing...</p>';
            
            // Get current user
            const { data: { user }, error: userError } = await client.auth.getUser();
            
            if (userError || !user) {
                output.innerHTML = '<p style="color: red;">❌ No authenticated user. Please log in first.</p>';
                return;
            }
            
            output.innerHTML += `<p>✅ Logged in as: ${user.email}</p>`;
            
            // Try school_educators first
            const { data: educator } = await client
                .from('school_educators')
                .select('school_id')
                .eq('user_id', user.id)
                .single();
            
            if (educator?.school_id) {
                output.innerHTML += `<p>✅ Found in school_educators: ${educator.school_id}</p>`;
                await fetchStudents(educator.school_id);
                return;
            }
            
            output.innerHTML += `<p>⚠️ Not found in school_educators, checking schools table...</p>`;
            
            // Try schools table by email
            const { data: school, error: schoolError } = await client
                .from('schools')
                .select('id, name')
                .eq('email', user.email)
                .single();
            
            if (schoolError) {
                output.innerHTML += `<p style="color: red;">❌ Error: ${schoolError.message}</p>`;
                return;
            }
            
            if (school?.id) {
                output.innerHTML += `<p>✅ Found in schools: ${school.name} (${school.id})</p>`;
                await fetchStudents(school.id);
            } else {
                output.innerHTML += `<p style="color: red;">❌ No school found for this email</p>`;
            }
        }
        
        async function fetchStudents(schoolId) {
            const { data: students, error } = await client
                .from('students')
                .select('id, name, email')
                .eq('school_id', schoolId);
            
            if (error) {
                output.innerHTML += `<p style="color: red;">❌ Error fetching students: ${error.message}</p>`;
                return;
            }
            
            output.innerHTML += `<p><strong>✅ Found ${students.length} students:</strong></p>`;
            output.innerHTML += '<ul>';
            students.forEach(s => {
                output.innerHTML += `<li>${s.name} (${s.email})</li>`;
            });
            output.innerHTML += '</ul>';
        }
        
        testLookup();
    </script>
</body>
</html>
