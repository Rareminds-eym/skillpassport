name: Deploy Development Workers

on:
  push:
    branches:
      - dev
    paths:
      - 'cloudflare-workers/**'
  workflow_dispatch:
    inputs:
      worker:
        description: 'Specific worker to deploy (leave empty for all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - assessment-api
          - career-api
          - course-api
          - email-api
          - embedding-api
          - fetch-certificate
          - otp-api
          - payments-api
          - storage-api
          - streak-api
          - user-api

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set deployment matrix
        id: set-matrix
        run: |
          ALL_WORKERS='["assessment-api","career-api","course-api","email-api","embedding-api","fetch-certificate","otp-api","payments-api","storage-api","streak-api","user-api"]'
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.worker }}" == "all" ]; then
              echo "matrix={\"worker\":$ALL_WORKERS}" >> $GITHUB_OUTPUT
            else
              echo "matrix={\"worker\":[\"${{ github.event.inputs.worker }}\"]}" >> $GITHUB_OUTPUT
            fi
          else
            # Detect changed workers from git diff
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '^cloudflare-workers/' | cut -d'/' -f2 | sort -u | grep -v '^README' || echo "")
            
            if [ -z "$CHANGED" ]; then
              echo "No worker changes detected, deploying all"
              echo "matrix={\"worker\":$ALL_WORKERS}" >> $GITHUB_OUTPUT
            else
              # Convert to JSON array
              JSON_ARRAY=$(echo "$CHANGED" | jq -R . | jq -s -c .)
              echo "matrix={\"worker\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
            fi
          fi

  deploy-workers:
    needs: detect-changes
    runs-on: ubuntu-latest
    environment:
      name: development
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Check if worker exists
        id: check-worker
        run: |
          if [ -d "cloudflare-workers/${{ matrix.worker }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install worker dependencies
        if: steps.check-worker.outputs.exists == 'true'
        working-directory: cloudflare-workers/${{ matrix.worker }}
        run: |
          if [ -f "package.json" ]; then
            npm install
          fi

      # - name: Run Linting (if configured)
      #   if: steps.check-worker.outputs.exists == 'true'
      #   working-directory: cloudflare-workers/${{ matrix.worker }}
      #   run: |
      #     if [ -f "package.json" ] && grep -q '"lint"' package.json; then
      #       npm run lint || echo "âš ï¸ Linting not configured or failed"
      #     else
      #       echo "â„¹ï¸ No linting configured for ${{ matrix.worker }}"
      #     fi
      #   continue-on-error: true

      # - name: Run Type Check (if TypeScript)
      #   if: steps.check-worker.outputs.exists == 'true'
      #   working-directory: cloudflare-workers/${{ matrix.worker }}
      #   run: |
      #     if [ -f "tsconfig.json" ]; then
      #       echo "ðŸ” Running TypeScript type check..."
      #       npx tsc --noEmit
      #     else
      #       echo "â„¹ï¸ No TypeScript configuration found"
      #     fi
      #   continue-on-error: false

      # - name: Run Tests (if configured)
      #   if: steps.check-worker.outputs.exists == 'true'
      #   working-directory: cloudflare-workers/${{ matrix.worker }}
      #   run: |
      #     if [ -f "package.json" ] && grep -q '"test"' package.json; then
      #       npm test || echo "âš ï¸ Tests not configured or failed"
      #     else
      #       echo "â„¹ï¸ No tests configured for ${{ matrix.worker }}"
      #     fi
      #   continue-on-error: true

      - name: Deploy ${{ matrix.worker }} (Development)
        if: steps.check-worker.outputs.exists == 'true'
        working-directory: cloudflare-workers/${{ matrix.worker }}
        run: |
          echo "ðŸ§ª Deploying ${{ matrix.worker }}-dev to development..."
          wrangler deploy --name ${{ matrix.worker }}-dev
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Set secrets for ${{ matrix.worker }}-dev
        if: steps.check-worker.outputs.exists == 'true'
        working-directory: cloudflare-workers/${{ matrix.worker }}
        run: |
          echo "ðŸ” Setting secrets for ${{ matrix.worker }}-dev..."
          
          # Common secrets for all workers
          if [ -n "${{ secrets.VITE_SUPABASE_URL }}" ]; then
            echo "${{ secrets.VITE_SUPABASE_URL }}" | wrangler secret put VITE_SUPABASE_URL --name ${{ matrix.worker }}-dev 2>/dev/null || true
          fi
          if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" | wrangler secret put SUPABASE_SERVICE_ROLE_KEY --name ${{ matrix.worker }}-dev 2>/dev/null || true
          fi
          
          # Worker-specific secrets
          case "${{ matrix.worker }}" in
            "embedding-api")
              if [ -n "${{ secrets.OPENROUTER_API_KEY }}" ]; then
                echo "${{ secrets.OPENROUTER_API_KEY }}" | wrangler secret put OPENROUTER_API_KEY --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              ;;
            "career-api"|"assessment-api")
              if [ -n "${{ secrets.OPENROUTER_API_KEY }}" ]; then
                echo "${{ secrets.OPENROUTER_API_KEY }}" | wrangler secret put OPENROUTER_API_KEY --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              ;;
            "payments-api")
              if [ -n "${{ secrets.RAZORPAY_KEY_ID }}" ]; then
                echo "${{ secrets.RAZORPAY_KEY_ID }}" | wrangler secret put RAZORPAY_KEY_ID --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              if [ -n "${{ secrets.RAZORPAY_KEY_SECRET }}" ]; then
                echo "${{ secrets.RAZORPAY_KEY_SECRET }}" | wrangler secret put RAZORPAY_KEY_SECRET --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              if [ -n "${{ secrets.RAZORPAY_WEBHOOK_SECRET }}" ]; then
                echo "${{ secrets.RAZORPAY_WEBHOOK_SECRET }}" | wrangler secret put RAZORPAY_WEBHOOK_SECRET --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              ;;
            "storage-api")
              if [ -n "${{ secrets.R2_ACCESS_KEY_ID }}" ]; then
                echo "${{ secrets.R2_ACCESS_KEY_ID }}" | wrangler secret put R2_ACCESS_KEY_ID --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              if [ -n "${{ secrets.R2_SECRET_ACCESS_KEY }}" ]; then
                echo "${{ secrets.R2_SECRET_ACCESS_KEY }}" | wrangler secret put R2_SECRET_ACCESS_KEY --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              if [ -n "${{ secrets.R2_BUCKET_NAME }}" ]; then
                echo "${{ secrets.R2_BUCKET_NAME }}" | wrangler secret put R2_BUCKET_NAME --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              ;;
            "email-api")
              if [ -n "${{ secrets.RESEND_API_KEY }}" ]; then
                echo "${{ secrets.RESEND_API_KEY }}" | wrangler secret put RESEND_API_KEY --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              ;;
            "otp-api")
              if [ -n "${{ secrets.TWILIO_ACCOUNT_SID }}" ]; then
                echo "${{ secrets.TWILIO_ACCOUNT_SID }}" | wrangler secret put TWILIO_ACCOUNT_SID --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              if [ -n "${{ secrets.TWILIO_AUTH_TOKEN }}" ]; then
                echo "${{ secrets.TWILIO_AUTH_TOKEN }}" | wrangler secret put TWILIO_AUTH_TOKEN --name ${{ matrix.worker }}-dev 2>/dev/null || true
              fi
              ;;
          esac
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-summary:
    needs: [detect-changes, deploy-workers]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸ§ª Development Workers Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy-workers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Development |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Development Workers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| assessment-api-dev | https://assessment-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| career-api-dev | https://career-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| course-api-dev | https://course-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| email-api-dev | https://email-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| embedding-api-dev | https://embedding-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| fetch-certificate-dev | https://fetch-certificate-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| otp-api-dev | https://otp-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| payments-api-dev | https://payments-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| storage-api-dev | https://storage-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| streak-api-dev | https://streak-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| user-api-dev | https://user-api-dev.dark-mode-d021.workers.dev |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "::error::Development worker deployment failed! Check the logs above for details."
          echo "## âŒ Development Worker Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more development workers failed to deploy. Please review the workflow logs." >> $GITHUB_STEP_SUMMARY
